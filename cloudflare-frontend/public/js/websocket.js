let cachedPlayerId=null,socket=new WebSocket("ws://localhost:3001"),sentRequests=0,receivedResponses=0,overlay=document.getElementById("overlay"),debugContainer=document.getElementById("debug-container"),positionText=document.getElementById("position"),packetsSentReceived=document.getElementById("packets-sent-received");import*as pako from"../libs/pako.js";import parseAPNG from"../libs/apng_parser.js";let userHasInteracted=!1,players=(socket.binaryType="arraybuffer",[]),npcs=[],userInteractionListener=()=>{userHasInteracted||(userHasInteracted=!0,document.removeEventListener("mousedown",userInteractionListener))},audioCache=(document.addEventListener("mousedown",userInteractionListener),new Map),npcImage=new Image,typingImage=(npcImage.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACMAAAAmCAYAAABOFCLqAAABhGlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9TxQ8qDq0g4pChioNdVMSxVLEIFkpboVUHk0u/oElDkuLiKLgWHPxYrDq4OOvq4CoIgh8g7oKToouU+L+k0CLGg+N+vLv3uHsHCI0KU82uKKBqlpGKx8RsblXseYWAPgQxgSGJmXoivZiB5/i6h4+vdxGe5X3uzzGg5E0G+ETiKNMNi3iDeHbT0jnvE4dYSVKIz4knDbog8SPXZZffOBcdFnhmyMik5olDxGKxg+UOZiVDJZ4hDiuqRvlC1mWF8xZntVJjrXvyFwby2kqa6zRHEccSEkhChIwayqjAQoRWjRQTKdqPefhHHH+SXDK5ymDkWEAVKiTHD/4Hv7s1C9NTblIgBnS/2PbHGNCzCzTrtv19bNvNE8D/DFxpbX+1Acx9kl5va+EjYHAbuLhua/IecLkDDD/pkiE5kp+mUCgA72f0TTkgeAv0r7m9tfZx+gBkqKvlG+DgEBgvUva6x7t7O3v790yrvx+jlHK64ZQ6gAAAAAZiS0dEAAAAAAAA+UO7fwAAAAlwSFlzAAAuIwAALiMBeKU/dgAAAAd0SU1FB+kCCRMwEsjIppIAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAB50lEQVRYw+2YvWvCYBDGn7xk0yRUKtqIiBBaUAoOznXv6B9b6GhnN3GRDErQRG2U1w9cStNB35hEjV/5sOBNuYRcft7de88h95LPW7gR4wHg/fURkrCMDYLOE/hofYMAgCQsQeeJ2EBYIgi7OS5UMS3VI4Oi8wSmpTrGhaq7TACgTBpQUYOyyZIkLJESg2+nyYyz46uGCWXS2IVhQKxsfSqhT7fPkuTHvl788mf7TstJ1PU9ZsTvVyTJjyvoNXZKLN7vZfuEOZrsat+nJwluyO4w/wKGPzaY9l0H4Z8MQ72nIUQJ2FsmNVWz5SBs0WRaOC3VoaZquzDpXhOmYUam3pKwhGmYSPea7jKxbEie8Ry2KZMGILB+Wq1hirlFrKcoJS6A1iYzn+0HyGJ8C99gxgHQ1z0ji9bmRjwgLBF2A8uihVWxgg6XiQSiw2WwKlZcFXFNYK2rI0lHkcAk6QhaVz889J6tISC6Uxdqaazh8Qksixa+2sb2COafrgZQtW0W3srZ87UpCAhvLCfUWTCsVN6yXeOrl6wQQWbl1Lj35eoOE9jaqWo64Gg2r3Zd6quaDvmcOTOYcZvBFPwUlsvZgxOe+KloWHZoSyB+Kho2kHdLIH4qGrZ5twTeT0XDNueWAADcLf3B+AfAy/vU2Mt7LwAAAABJRU5ErkJggg==",new Image),onlinecount=(typingImage.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAAVCAYAAADfLRcdAAABhWlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV+/qEhF0A4iDhmqONhFRcSpVLEIFkpboVUHk0u/oElDkuLiKLgWHPxYrDq4OOvq4CoIgh8g7oKToouU+L+k0CLGg+N+vLv3uHsHeJtVphj+GKCopp5OxIVcflUIviIAPwYwh3GRGVoys5iF6/i6h4evd1Ge5X7uz9EnFwwGeATiGNN0k3iDeGbT1DjvE4dZWZSJz4kndLog8SPXJYffOJds9vLMsJ5NzxOHiYVSF0tdzMq6QjxNHJEVlfK9OYdlzluclWqdte/JXxgqqCsZrtMcQQJLSCIFARLqqKAKE1FaVVIMpGk/7uIftv0pcknkqoCRYwE1KBBtP/gf/O7WKE5NOkmhOBB4sayPUSC4C7QalvV9bFmtE8D3DFypHX+tCcx+kt7oaJEjoH8buLjuaNIecLkDDD1poi7ako+mt1gE3s/om/LA4C3Qu+b01t7H6QOQpa6Wb4CDQ2CsRNnrLu/u6e7t3zPt/n4A+Ehy3OEAdvwAAAAGYktHRACjAGoAQYpfYckAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfpBQQTFRn3o6swAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAAAIVJREFUSMdjZEACqday/xkGGZh99DEjjM3EMITAkHIsI3LUK4nxwSWOXH80YI6y0ZSDs++9+sQwmgxoDViQOchR/+bTtwFzFLI7pIQFRpMBfZMBLtAY/hfOrl/JPCBqR5MB3SqFZ28/DIrSQISPa7Q0GLjSALlOHm0bjKjSYLSnMJoMGBgAuS4u7T48tcgAAAAASUVORK5CYII=",document.getElementById("onlinecount")),canvas=document.getElementById("game"),ctx=canvas.getContext("2d"),progressBar=document.getElementById("progress-bar"),progressBarContainer=document.getElementById("progress-bar-container"),inventoryUI=document.getElementById("inventory"),spellBookUI=document.getElementById("spell-book-container"),friendsListUI=document.getElementById("friends-list-container"),friendsList=document.getElementById("friends-list-content"),friendsListSearch=document.getElementById("friends-list-search"),inventoryGrid=document.getElementById("grid"),statUI=document.getElementById("stat-screen"),chatInput=document.getElementById("chat-input"),chatMessages=document.getElementById("chat-messages"),loadingScreen=document.getElementById("loading-screen"),xpBar=document.getElementById("xp-bar"),healthBar=document.getElementById("health-progress-bar"),staminaBar=document.getElementById("stamina-progress-bar"),targetHealthBar=document.getElementById("target-health-progress-bar"),targetStaminaBar=document.getElementById("target-stamina-progress-bar"),pauseMenu=document.getElementById("pause-menu-container"),optionsMenu=document.getElementById("options-menu-container"),menuElements=["options-menu-container"],fpsSlider=document.getElementById("fps-slider"),musicSlider=document.getElementById("music-slider"),effectsSlider=document.getElementById("effects-slider"),mutedCheckbox=document.getElementById("muted-checkbox"),healthLabel=document.getElementById("stats-screen-health-label"),manaLabel=document.getElementById("stats-screen-mana-label"),loaded=!1,toggleInventory=!1,toggleSpellBook=!1,toggleFriendsList=!1,times=[],lastFrameTime=0,controllerConnected=!1,cameraX=0,cameraY=0,lastSentDirection="",lastUpdate=(canvas.style.position="absolute",performance.now());function lerp(e,t,a){return e+(t-e)*a}window.addEventListener("gamepadconnected",()=>{controllerConnected=!0}),window.addEventListener("gamepaddisconnected",()=>{controllerConnected=!1});let packet={decode(e){return(new TextDecoder).decode(e)},encode(e){return(new TextEncoder).encode(e)}},lastDirection="",pendingRequest=!1,cachedViewport={x:0,y:0,w:window.innerWidth,h:window.innerHeight,padding:64},cachedPaddedBounds={x:0,y:0,w:0,h:0};function updateViewportCache(){cachedViewport.w=window.innerWidth,cachedViewport.h=window.innerHeight,cachedPaddedBounds.w=cachedViewport.w+2*cachedViewport.padding,cachedPaddedBounds.h=cachedViewport.h+2*cachedViewport.padding}function animationLoop(){if(ctx){var n=1e3/parseFloat(fpsSlider.value),e=performance.now(),i=(e-lastFrameTime)/1e3;if(!(e-lastFrameTime<n)){lastFrameTime=e;let a=players.find(e=>e.id===cachedPlayerId);if(a){if(updateCamera(a),isMoving&&isKeyPressed){if(document.activeElement===chatInput||document.activeElement===friendsListSearch)return isMoving=!1,void(lastDirection="");n=pressedKeys;let e="";n.has("KeyW")&&n.has("KeyA")?e="UPLEFT":n.has("KeyW")&&n.has("KeyD")?e="UPRIGHT":n.has("KeyS")&&n.has("KeyA")?e="DOWNLEFT":n.has("KeyS")&&n.has("KeyD")?e="DOWNRIGHT":n.has("KeyW")?e="UP":n.has("KeyS")?e="DOWN":n.has("KeyA")?e="LEFT":n.has("KeyD")&&(e="RIGHT"),e&&e!==lastDirection&&!pendingRequest&&(pendingRequest=!0,sendRequest({type:"MOVEXY",data:e}),lastDirection=e,setTimeout(()=>pendingRequest=!1,50))}else isMoving&&!isKeyPressed&&(""!==lastDirection&&sendRequest({type:"MOVEXY",data:"ABORT"}),isMoving=!1,lastDirection="");cachedViewport.x=window.scrollX,cachedViewport.y=window.scrollY,cachedPaddedBounds.x=cachedViewport.x-cachedViewport.padding,cachedPaddedBounds.y=cachedViewport.y-cachedViewport.padding,ctx.clearRect(cachedViewport.x,cachedViewport.y,cachedViewport.w,cachedViewport.h);let t=(e,t)=>e>=cachedPaddedBounds.x&&t>=cachedPaddedBounds.y&&e<=cachedPaddedBounds.x+cachedPaddedBounds.w&&t<=cachedPaddedBounds.y+cachedPaddedBounds.h;var s,o,n=players.filter(e=>t(e.position.x,e.position.y)&&(e.id===cachedPlayerId||!e.isStealth||e.isStealth&&a.isAdmin)),r=(a&&({health:o,max_health:l,stamina:r,max_stamina:s}=a.stats,o=o/l*100,l=r/s*100,updateHealthBar(healthBar,o),updateStaminaBar(staminaBar,l)),players.find(e=>e.targeted)),l=(r&&({health:s,max_health:o,stamina:l,max_stamina:r}=r.stats,s=s/o*100,o=l/r*100,updateHealthBar(targetHealthBar,s),updateStaminaBar(targetStaminaBar,o)),npcs.filter(e=>t(e.position.x,e.position.y)));if(window.mapLayerCanvases){for(var d of window.mapLayerCanvases)d.zIndex<3&&ctx.drawImage(d.canvas,cachedViewport.x,cachedViewport.y,cachedViewport.w,cachedViewport.h,cachedViewport.x,cachedViewport.y,cachedViewport.w,cachedViewport.h);for(var c of n)c.show(ctx);for(var p of l){if(p.show(ctx),p.particles)for(var m of p.particles)m.visible&&p.updateParticle(m,p,ctx,i);p.dialogue(ctx)}for(var h of window.mapLayerCanvases)3<=h.zIndex&&ctx.drawImage(h.canvas,cachedViewport.x,cachedViewport.y,cachedViewport.w,cachedViewport.h,cachedViewport.x,cachedViewport.y,cachedViewport.w,cachedViewport.h);for(var u of n)u.showChat(ctx)}60<times.length&&times.shift(),times.push(e)}}requestAnimationFrame(animationLoop)}}updateViewportCache(),animationLoop();let cameraSmoothing=.05;function updateCamera(e){var t,a;loaded&&e&&(t=performance.now(),a=Math.min((t-lastUpdate)/16.67,2),lastUpdate=t,t=e.position.x-window.innerWidth/2+8,e=e.position.y-window.innerHeight/2+48,a=1-Math.pow(1-cameraSmoothing,a),cameraX=lerp(cameraX,t,a),cameraY=lerp(cameraY,e,a),window.scrollTo(Math.round(cameraX),Math.round(cameraY)))}window.addEventListener("gamepadjoystick",t=>{if(loaded&&"block"!=pauseMenu.style.display){var a=t.detail.x,t=t.detail.y;if(Math.abs(a)<.5&&Math.abs(t)<.5)"ABORT"!==lastSentDirection&&(sendRequest({type:"MOVEXY",data:"ABORT"}),lastSentDirection="ABORT");else{t=Math.atan2(t,a)*(180/Math.PI);let e="";-22.5<=t&&t<22.5?e="RIGHT":22.5<=t&&t<67.5?e="DOWNRIGHT":67.5<=t&&t<112.5?e="DOWN":112.5<=t&&t<157.5?e="DOWNLEFT":157.5<=t||t<-157.5?e="LEFT":-157.5<=t&&t<-112.5?e="UPLEFT":-112.5<=t&&t<-67.5?e="UP":-67.5<=t&&t<-22.5&&(e="UPRIGHT"),e&&e!==lastSentDirection&&"block"!=pauseMenu.style.display&&(sendRequest({type:"MOVEXY",data:e}),lastSentDirection=e)}}}),socket.onopen=()=>{sendRequest({type:"PING",data:null})},socket.onclose=()=>{showNotification("You have been disconnected from the server",!(progressBarContainer.style.display="none"),!0)},socket.onerror=()=>{showNotification("An error occurred while connecting to the server",!(progressBarContainer.style.display="none"),!0)};let animationCache=new Map;function updateXp(e,t,a){e=Math.max(0,Math.min(1,e/a));xpBar.animate([{transform:`scaleX(${e})`}],{duration:0,fill:"forwards"})}function playMusic(e,t,a){if(userHasInteracted){var n=!(a<performance.now()-36e5)&&audioCache.get(e)||pako.inflate(new Uint8Array(t),{to:"string"}),i=new Audio("data:audio/wav;base64,"+n);if(i){var s=Number(musicSlider.value);i.volume=mutedCheckbox.checked||0===s?0:s/100,i.loop=!0;try{i.play(),audioCache.set(e,n),startMusicInterval(i)}catch(e){console.error(e)}}else console.error("Failed to create audio element")}else setTimeout(()=>{playMusic(e,t,a)},100)}function startMusicInterval(t){setInterval(()=>{var e=Number(musicSlider.value);t.volume=mutedCheckbox.checked||0===e?0:e/100},100)}function playAudio(e,t,a,n){if(userHasInteracted){if(!mutedCheckbox.checked){var i="0"===effectsSlider.value?0:Number(effectsSlider.value)/100,s=!(n<performance.now()-36e5)&&audioCache.get(e)||pako.inflate(new Uint8Array(t),{to:"string"}),o=new Audio("data:audio/wav;base64,"+s);if(o){o.playbackRate=a,o.volume=i,o.autoplay=!0;try{o.play(),audioCache.set(e,s)}catch(e){console.error(e)}}else console.error("Failed to create audio element")}}else setTimeout(()=>{playAudio(e,t,a,n)},100)}function getCookie(e){var a=e+"=",n=decodeURIComponent(document.cookie).split(";");for(let t=0;t<n.length;t++){let e=n[t];for(;" "==e.charAt(0);)e=e.substring(1);if(0==e.indexOf(a))return e.substring(a.length,e.length)}return""}let isKeyPressed=!(socket.onmessage=async a=>{var m;if(receivedResponses++,a.data instanceof ArrayBuffer)try{var e=JSON.parse(packet.decode(a.data));let s=e.data;var t,n,i,o,r=e.type;if(r)switch(r){case"INVITATION":s&&createInvitationPopup(s);break;case"UPDATE_FRIENDS":s&&s.friends&&(t=players.find(e=>e.id===cachedPlayerId))&&(t.friends=s.friends||[],updateFriendsList(s));break;case"UPDATE_ONLINE_STATUS":s&&void 0!==s.username&&void 0!==s.online&&updateFriendOnlineStatus(s.username,s.online);break;case"UPDATE_PARTY":s&&s.members&&(n=players.find(e=>e.id===cachedPlayerId))&&(n.party=s.members||[],createPartyUI(n.party));break;case"ANIMATION":{let a;try{if(animationCache.has(s.name)?(i=animationCache.get(s.name),a=parseAPNG(i)):(o=pako.inflate(new Uint8Array(s.data.data)),a=parseAPNG(o.buffer),animationCache.set(s.name,o.buffer)),!(a instanceof Error)&&players){let t=async()=>{var e=players.find(e=>e.id===s.id);e?(e.animation={frames:a.frames,currentFrame:0,lastFrameTime:performance.now()},a.frames.forEach(e=>e.createImage())):(await new Promise(e=>setTimeout(e,100)),await t())};t().catch(e=>console.error("Error in findPlayer:",e))}}catch(e){console.error("Failed to process animation data:",e)}break}case"PONG":sendRequest({type:"LOGIN",data:null});break;case"TIME_SYNC":setTimeout(async()=>{sendRequest({type:"TIME_SYNC",data:s})},5e3);break;case"CONNECTION_COUNT":onlinecount.innerText=s+" online";break;case"SPAWN_PLAYER":await isLoaded(),createPlayer(s);break;case"RECONNECT":window.location.reload();break;case"LOAD_PLAYERS":if(await isLoaded(),!s)return;players.forEach((e,t)=>{e.id!==cachedPlayerId&&players.splice(t,1)}),s.forEach(a=>{a.id!=cachedPlayerId&&(players.forEach((e,t)=>{e.id===a.id&&players.splice(t,1)}),createPlayer(a))});break;case"DISCONNECT_PLAYER":if(!s||!s.id||!s.username)return;console.log(`Player (${s.username}) ${s.id} disconnected`),updateFriendOnlineStatus(s.username,!1);var l=players.findIndex(e=>e.id===s.id);-1!==l&&players.splice(l,1);break;case"MOVEXY":var d,c,p=players.find(e=>e.id===s.id);if(!p)return;"abort"!==s._data&&(p.typing=!1,d=canvas.width/2+s._data.x,c=canvas.height/2+s._data.y,s.id!==cachedPlayerId?(p.position.x=d,p.position.y=c):(p.position.x=d,p.position.y=c,positionText.innerText=`Position: ${s._data.x}, `+s._data.y));break;case"CREATE_NPC":if(await isLoaded(),!s)return;console.log("Creating NPC:",s),createNPC(s);break;case"LOAD_MAP":{var h=pako.inflate(new Uint8Array(new Uint8Array(s[0].data)),{to:"string"});let p=h?JSON.parse(h):null;try{var u=await(async e=>{if(e?.length)return e=e.map(async e=>{let n=e.image.split("/").pop();e=await fetch("/tileset?name="+n);if(!e.ok)throw new Error("Failed to fetch tileset: "+n);e=await e.json();let i=pako.inflate(new Uint8Array(e.tileset.data.data),{to:"string"});return new Promise((e,t)=>{let a=new Image;a.onload=()=>e(a),a.onerror=()=>t(new Error("Failed to load tileset image: "+n)),a.src="data:image/png;base64,"+i})}),Promise.all(e);throw new Error("No tilesets found")})(p.tilesets);if(!u.length)throw new Error("No tileset images loaded");m=u,await new Promise(t=>{let n=p.width*p.tilewidth,i=p.height*p.tileheight,a=p.layers.map((e,t)=>{var a=document.createElement("canvas");return a.width=n,a.height=i,{canvas:a,ctx:a.getContext("2d",{willReadFrequently:!1}),zIndex:e.zIndex||t}}),s=(canvas.width=n,canvas.height=i,canvas.style.width=n+"px",canvas.style.height=i+"px",canvas.style.display="block",[...p.layers].sort((e,t)=>(e.zIndex||0)-(t.zIndex||0)));let o=100/s.filter(e=>e.visible&&"tilelayer"===e.type).length,r=0,c=0;async function l(l,e){let d=e.ctx;d.imageSmoothingEnabled=!1;c+=o,progressBar.style.width=Math.min(c,100)+"%",await async function e(t){for(let a=t;a<t+10&&a<p.height;a++)for(let e=0;e<p.width;e++){let t=l.data[a*p.width+e];var n,i,s,o,r;0!==t&&(n=p.tilesets.find(e=>e.firstgid<=t&&t<e.firstgid+e.tilecount))&&(i=m[p.tilesets.indexOf(n)])&&(o=(r=t-n.firstgid)%(s=Math.floor(n.imagewidth/n.tilewidth))*n.tilewidth,r=Math.floor(r/s)*n.tileheight,d.drawImage(i,o,r,n.tilewidth,n.tileheight,e*p.tilewidth,a*p.tileheight,p.tilewidth,p.tileheight))}t+10<p.height&&(await new Promise(e=>setTimeout(e,0)),await e(t+10))}(0)}loaded=!0,(async()=>{for(;r<s.length;){let t=s[r];var e;t.visible&&"tilelayer"===t.type&&"collisions"!==t.name.toLowerCase()?((e=a.find(e=>e.zIndex===(t.zIndex||r)))&&await l(t,e),r++,await new Promise(e=>requestAnimationFrame(e))):r++}progressBar.style.width="100%",window.mapLayerCanvases=a.sort((e,t)=>e.zIndex-t.zIndex),t(),setTimeout(()=>{loadingScreen&&(loadingScreen.style.transition="1s",loadingScreen.style.opacity="0",setTimeout(()=>{loadingScreen.style.display="none",progressBar.style.width="0%",progressBarContainer.style.display="block"},1e3))},1e3)})()})}catch(e){throw console.error("Map loading failed:",e),e}}break;case"LOGIN_SUCCESS":var y=JSON.parse(packet.decode(a.data)).data,g=JSON.parse(packet.decode(a.data)).chatDecryptionKey,f=(sessionStorage.setItem("connectionId",y),cachedPlayerId=y,getCookie("token"));f?(sessionStorage.setItem("chatDecryptionKey",g),sendRequest({type:"AUTH",data:f,language:navigator.language.split("-")[0]||navigator.language||"en"})):window.location.href="/";break;case"LOGIN_FAILED":window.location.href="/";break;case"INVENTORY":var w=JSON.parse(packet.decode(a.data)).data,U=JSON.parse(packet.decode(a.data)).slots;if(0<w.length)for(let e=0;e<w.length;e++){let t=document.createElement("div");t.classList.add("slot"),t.classList.add("ui");var v=w[e];if(t.classList.add(v.quality.toLowerCase()||"empty"),v.icon){var I,F=pako.inflate(new Uint8Array(v.icon.data),{to:"string"});let e=new Image;e.src="data:image/png;base64,"+F,e.onload=()=>{t.appendChild(e)},1<v.quantity&&((I=document.createElement("div")).classList.add("quantity-label"),I.innerText="x"+v.quantity,t.appendChild(I))}else t.innerHTML=""+v.item+(1<v.quantity?"<br>x"+v.quantity:"");inventoryGrid.appendChild(t)}for(let e=0;e<U-w.length;e++){var E=document.createElement("div");E.classList.add("slot"),E.classList.add("empty"),E.classList.add("ui"),inventoryGrid.appendChild(E)}break;case"QUESTLOG":var K=JSON.parse(packet.decode(a.data)).data;console.log(K);break;case"QUESTDETAILS":var q=JSON.parse(packet.decode(a.data)).data;console.log(q);break;case"CHAT":players.forEach(e=>{var t,a,n,i;e.id===s.id&&(e.chat=s.message,t=s?.username?.charAt(0).toUpperCase()+s?.username?.slice(1),a=(new Date).toLocaleTimeString(),""!==s.message?.trim())&&t&&((n=document.createElement("div")).classList.add("message"),n.style.userSelect="text",i=s.message.replace(/</g,"&lt;").replace(/>/g,"&gt;"),n.innerHTML=a+` ${t}: `+i,chatMessages.appendChild(n),chatMessages.scrollTop=chatMessages.scrollHeight,e.typing=!1)});break;case"TYPING":players.forEach(e=>{e.id===s.id&&(e.typing=!0,e.typingTimeout&&clearTimeout(e.typingTimeout),e.typingTimeout=setTimeout(()=>{e.typing=!1},3e3))});break;case"STOPTYPING":players.forEach(e=>{e.id===s.id&&(e.typing=!1)});break;case"NPCDIALOG":var A=npcs.find(e=>e.id===s.id);if(!A)return;A.dialog=s.dialog;break;case"STATS":var x=players.find(e=>e.id===s.id);if(!x)return;updateXp(s.xp,s.level,s.max_xp),x.stats=s;break;case"CLIENTCONFIG":var S=JSON.parse(packet.decode(a.data)).data[0];fpsSlider.value=S.fps,document.getElementById("limit-fps-label").innerText=`FPS: (${fpsSlider.value})`,musicSlider.value=S.music_volume||0,document.getElementById("music-volume-label").innerText=`Music: (${musicSlider.value})`,effectsSlider.value=S.effects_volume||0,document.getElementById("effects-volume-label").innerText=`Effects: (${effectsSlider.value})`,mutedCheckbox.checked=S.muted,document.getElementById("muted-checkbox").innerText="Muted: "+mutedCheckbox.checked;break;case"SELECTPLAYER":{let t=JSON.parse(packet.decode(a.data)).data;if(!t||!t.id||!t.username){var C=players.find(e=>e.targeted);C&&(C.targeted=!1);break}players.forEach(e=>{e.targeted=e.id===t.id});break}case"STEALTH":{let t=JSON.parse(packet.decode(a.data)).data;var b=players.find(e=>e.id===cachedPlayerId||e.id===cachedPlayerId);b&&t.id===b.id&&sendRequest({type:"MOVEXY",data:"ABORT"}),players.forEach(e=>{e.id===t.id&&(e.isStealth=t.isStealth),e.isStealth&&e.targeted&&(e.targeted=!1)});break}case"UPDATESTATS":{let{target:t,stats:e}=JSON.parse(packet.decode(a.data)).data;var T=players.find(e=>e.id===t);T&&(T.stats=e);break}case"REVIVE":{let t=JSON.parse(packet.decode(a.data)).data;var k=players.find(e=>e.id===t.target);if(!k)return;k.stats=t.stats,k.id.toString()===cachedPlayerId||(k.targeted=!1),players.forEach(e=>e.targeted=!1);break}case"UPDATE_XP":var L=JSON.parse(packet.decode(a.data)).data;L.id===cachedPlayerId&&updateXp(L.xp,L.level,L.max_xp);break;case"AUDIO":var Y=JSON.parse(packet.decode(a.data)).name,V=JSON.parse(packet.decode(a.data)).data,H=JSON.parse(packet.decode(a.data)).pitch||1,G=JSON.parse(packet.decode(a.data)).timestamp;playAudio(Y,V.data.data,H,G);break;case"MUSIC":var _=JSON.parse(packet.decode(a.data)).name,X=JSON.parse(packet.decode(a.data)).data,J=JSON.parse(packet.decode(a.data)).timestamp;playMusic(_,X.data.data,J);break;case"INSPECTPLAYER":var R=JSON.parse(packet.decode(a.data)).data;statUI.setAttribute("data-id",R.id),healthLabel.innerText=`Health: (${R.stats.health})`,manaLabel.innerText=`Mana: (${R.stats.stamina})`,statUI.style.transition="1s",statUI.style.left="10";break;case"NOTIFY":showNotification(JSON.parse(packet.decode(a.data)).data.message,!0,!1);break;case"WHISPER":var P,B,N=JSON.parse(packet.decode(a.data)).data,W=N.message.replace(/</g,"&lt;").replace(/>/g,"&gt;"),Q=(new Date).toLocaleTimeString();""!==N.message?.trim()&&N.username&&((P=document.createElement("div")).classList.add("message"),P.style.userSelect="text",B=N.username.charAt(0).toUpperCase()+N.username.slice(1),P.innerHTML=Q+` <span class="whisper-username">${B}:</span> <span class="whisper-message">${W}</span>`,chatMessages.appendChild(P),chatMessages.scrollTop=chatMessages.scrollHeight);break;case"PARTY_CHAT":var M,O,D=JSON.parse(packet.decode(a.data)).data,z=D.message.replace(/</g,"&lt;").replace(/>/g,"&gt;"),Z=(new Date).toLocaleTimeString();""!==D.message?.trim()&&D.username&&((M=document.createElement("div")).classList.add("message"),M.style.userSelect="text",O=D.username.charAt(0).toUpperCase()+D.username.slice(1),M.innerHTML=Z+` <span class="party-username">${O}:</span> <span class="party-message">${z}</span>`,chatMessages.appendChild(M),chatMessages.scrollTop=chatMessages.scrollHeight);break;case"CURRENCY":var j=JSON.parse(packet.decode(a.data)).data;console.log("Currency data received:",j)}else console.warn("Received message without type:",e)}catch(e){console.error("Error processing WebSocket message:",e),console.error("Message data:",a.data)}}),isMoving=!1,pressedKeys=new Set,movementKeys=new Set(["KeyW","KeyA","KeyS","KeyD"]),lastTypingPacket=0,typingTimer=null,cooldowns=(chatInput.addEventListener("input",()=>{typingTimer&&window.clearTimeout(typingTimer),lastTypingPacket+1e3<performance.now()&&(sendRequest({type:"TYPING",data:null}),lastTypingPacket=performance.now()),typingTimer=window.setTimeout(()=>{0<chatInput.value.length&&(sendRequest({type:"TYPING",data:null}),lastTypingPacket=performance.now())},1e3)}),{}),COOLDOWN_DURATION=1e3,keyHandlers={F2:()=>toggleDebugContainer(),Escape:()=>handleEscapeKey(),KeyB:()=>{toggleInventory=toggleUI(inventoryUI,toggleInventory,-350)},KeyP:()=>{toggleFriendsList=toggleFriendsList&&toggleUI(friendsListUI,toggleFriendsList,-425),toggleSpellBook=toggleUI(spellBookUI,toggleSpellBook,-425)},KeyO:()=>{toggleSpellBook=toggleSpellBook&&toggleUI(spellBookUI,toggleSpellBook,-425),toggleFriendsList=toggleUI(friendsListUI,toggleFriendsList,-425)},KeyC:()=>handleStatsUI(),KeyX:()=>sendRequest({type:"STEALTH",data:null}),KeyZ:()=>sendRequest({type:"NOCLIP",data:null}),Enter:async()=>handleEnterKey(),Space:()=>handleSpaceKey()},blacklistedKeys=new Set(["ContextMenu","AltLeft","AltRight","ControlLeft","ControlRight","ShiftLeft","ShiftRight","F1","F3","F4","F5","F6","F7","F8","F9","F10","Tab"]);function toggleDebugContainer(){debugContainer.style.display="block"===debugContainer.style.display?"none":"block"}function toggleUI(e,t,a){return e.style.transition="1s",e.style.right=t?a.toString():"10",!t}function handleStatsUI(){var e=statUI.getAttribute("data-id")===cachedPlayerId;"10px"===statUI.style.left&&e?(statUI.style.transition="1s",statUI.style.left="-570"):sendRequest({type:"INSPECTPLAYER",data:null})}function handleEscapeKey(){stopMovement(),chatInput.blur();var e="block"===pauseMenu.style.display;pauseMenu.style.display=e?"none":"block",menuElements.forEach(e=>{e=document.getElementById(e);"block"===e?.style.display&&(e.style.display="none")})}async function handleEnterKey(){var e;friendsListSearch!==document.activeElement&&(chatInput===document.activeElement?(sendRequest({type:"STOPTYPING",data:null}),(e=chatInput.value.trim())&&(e.startsWith("/")?await handleCommand(e):await handleChatMessage(e)),chatInput.value="",chatInput.blur()):(sentRequests++,chatInput.focus()))}async function handleCommand(e){var t,e=e.substring(1);window?.crypto?.subtle?(t=sessionStorage.getItem("chatDecryptionKey"))&&sendRequest({type:"COMMAND",data:{command:await encryptRsa(t,e||" "),mode:"decrypt"}}):(sentRequests++,sendRequest({type:"COMMAND",data:{command:e||" "}}))}async function handleChatMessage(e){if(window?.crypto?.subtle){var t=sessionStorage.getItem("chatDecryptionKey");if(!t)return;sendRequest({type:"CHAT",data:{message:await encryptRsa(t,e||" "),mode:"decrypt"}})}else sentRequests++,sendRequest({type:"CHAT",data:{message:e||" ",mode:null}});setTimeout(()=>{players.find(e=>e.id===cachedPlayerId)?.chat===e&&sendRequest({type:"CHAT",data:null})},7e3+35*e.length)}function handleSpaceKey(){var e=players.find(e=>e.targeted);e&&sendRequest({type:"ATTACK",data:e})}let contextMenuKeyTriggered=!1;function handleKeyPress(){!loaded||controllerConnected||"block"===pauseMenu.style.display||isMoving||(isMoving=!0,lastDirection="",pendingRequest=!1)}async function isLoaded(){await new Promise(e=>{let t=setInterval(()=>{loaded&&(clearInterval(t),e())},10)})}function createNPC(t){let a={id:t.id,dialog:t.dialog||"",position:{x:canvas.width/2+t.location.x,y:canvas.height/2+t.location.y},particles:t.particles||[],quest:t.quest||null,dialogue:function(a){if(this.dialog&&""!==this.dialog.trim()){a.fillStyle="black",a.fillStyle="white",a.font="14px 'Comic Relief'",a.textAlign="center";var n=getLines(a,this.dialog,500).reverse();let t=this.position.y;for(let e=0;e<n.length;e++)t-=15,a.fillText(n[e],this.position.x+16,t)}},show:function(e){npcImage&&e&&(e.globalAlpha=1,t?.hidden||e.drawImage(npcImage,this.position.x,this.position.y,npcImage.width,npcImage.height))},updateParticle:async(t,a,n,i)=>{a.particleArrays||(a.particleArrays={},a.lastEmitTime={});var e,s,o,r,l=performance.now(),d=16.67*(t.interval||1),c=(a.lastEmitTime[t.name||""]||(a.lastEmitTime[t.name||""]=l),a.particleArrays[t.name||""]||(a.particleArrays[t.name||""]=[]),l-a.lastEmitTime[t.name||""]>=d&&(d=Math.random()*(t.staggertime||0),e=t.lifetime||1e3,r="object"==typeof t.weather?t.weather.wind_direction:null,s="object"==typeof t.weather&&t.weather.wind_speed||0,o={x:0,y:0},null===r||"left"!==r&&"right"!==r||(r=("left"!==r&&"right"===r?0:180)*Math.PI/180,o.x=Math.cos(r)*s*.5,o.y=Math.sin(r)*s*.5),r={...t,localposition:{x:Number(t.localposition?.x||0)+(Math.random()<.5?-1:1)*Math.random()*Number(t.spread.x),y:Number(t.localposition?.y||0)+(Math.random()<.5?-1:1)*Math.random()*Number(t.spread.y)},velocity:{x:Number(t.velocity.x||0)+o.x,y:Number(t.velocity.y||0)+o.y},lifetime:e+d,currentLife:e+d,opacity:t.opacity||1,visible:!0,size:t.size||5,color:t.color||"white",gravity:{...t.gravity},weather:"object"==typeof t.weather?{...t.weather}:"none"},a.particleArrays[t.name||""].length>=t.amount&&a.particleArrays[t.name||""].shift(),a.particleArrays[t.name||""].push(r),a.lastEmitTime[t.name||""]=l),a.particleArrays[t.name||""]);for(let e=c.length-1;0<=e;e--){var p=c[e];if(p.currentLife-=1e3*i,p.currentLife<=0)c.splice(e,1);else{p.localposition||(p.localposition={x:0,y:0}),p.velocity&&p.gravity&&(u="object"==typeof p.weather?p.weather.wind_direction:null,h="object"==typeof p.weather&&p.weather.wind_speed||0,m={x:0,y:0},"none"===u||"left"!==u&&"right"!==u||(u=("left"===u?180:0)*Math.PI/180,m.x=Math.cos(u)*h*.01,m.y=Math.sin(u)*h*.01),p.velocity.x+=p.gravity.x*i+m.x,p.velocity.y+=p.gravity.y*i+m.y,u={x:t.velocity.x+.2*h,y:t.velocity.y+.2*h},p.velocity.x=Math.min(Math.max(p.velocity.x,-u.x),u.x),p.velocity.y=Math.min(Math.max(p.velocity.y,-u.y),u.y),p.localposition.x+=p.velocity.x*i,p.localposition.y+=p.velocity.y*i);var m=a.position.x+16-p.size/2,h=a.position.y+24-p.size/2,u=m+p.localposition.x,y=h+p.localposition.y,g=.4*p.lifetime,f=.4*p.lifetime;let e;e=p.lifetime-p.currentLife<g?(p.lifetime-p.currentLife)/g*p.opacity:p.currentLife<f?p.currentLife/f*p.opacity:p.opacity,n.globalAlpha=e,n.beginPath(),n.arc(u+p.size/2,y+p.size/2,p.size/2,0,2*Math.PI),n.fillStyle=p.color||"white",n.fill()}}n.globalAlpha=1}};npcs.push(a),async function(){try{await isLoaded(),new Function("with(this) { "+decodeURIComponent(t.script)+" }").call(a)}catch(e){console.error(`NPC script error (ID: ${a.id}):`,e)}}.call(a)}async function createPlayer(s){positionText.innerText=`Position: ${s.location.x}, `+s.location.y,updateFriendOnlineStatus(s.username,!0);console.log(`
    Username: ${s.username}
    UserID: ${s.userid}
    WebSocket ID: ${s.id}
    Animation: ${s.animation?"Loaded":"None"}
    Friends: ${s.friends?s.friends.join(", "):"None"}
    Position: (${s.location.x}, ${s.location.y})
    Stealth: ${s.isStealth?"Yes":"No"}
    Admin: ${s.isAdmin?"Yes":"No"}
    Guest: ${s.isGuest?"Yes":"No"}
    Party: ${s.party?s.party.join(", "):"None"}
    Stats: ${JSON.stringify(s.stats,null,2)}
  `),console.log(s.currency);var e={id:s.id,username:s.username,userid:s.userid,animation:await(async e=>{if(e?.data?.data)try{var t=pako.inflate(new Uint8Array(e.data.data)),a=parseAPNG(t.buffer);if(!(a instanceof Error))return a.frames.forEach(e=>e.createImage()),{frames:a.frames,currentFrame:0,lastFrameTime:performance.now()}}catch(e){console.error("Failed to initialize animation:",e)}return null})(s.animation),friends:s.friends||[],position:{x:canvas.width/2+s.location.x,y:canvas.height/2+s.location.y},chat:"",isStealth:s.isStealth,isAdmin:s.isAdmin,isGuest:s.isGuest||!1,_adminColorHue:Math.floor(360*Math.random()),targeted:!1,stats:s.stats,typing:!1,typingTimeout:null,typingImage:typingImage,party:s.party||null,showChat:function(a){if(this.chat&&""!==this.chat.trim()){a.fillStyle="black",a.fillStyle="white",a.textAlign="center",a.shadowBlur=1,a.shadowColor="black",a.shadowOffsetX=1,a.shadowOffsetY=1,a.font="14px 'Comic Relief'";var n=getLines(a,this.chat,500).reverse();let t=this.position.y;for(let e=0;e<n.length;e++){t-=20;var i=a.measureText(n[e]).width;a.fillStyle="rgba(0, 0, 0, 0.2)",a.fillRect(this.position.x+16-i/2-5,t-17,i+10,20),a.fillStyle="white",a.fillText(n[e],this.position.x+16,t)}}this.typing&&this.typingImage&&(this.isStealth&&(a.globalAlpha=.8),a.shadowColor="black",a.shadowBlur=2,a.shadowOffsetX=0,a.shadowOffsetY=0,a.drawImage(this.typingImage,this.position.x-this.typingImage.width+15,this.position.y-this.typingImage.height+15,this.typingImage.width/1.5,this.typingImage.height/1.5),a.globalAlpha=1,a.shadowColor="transparent",a.shadowBlur=0),a.shadowColor="transparent",a.shadowBlur=0,a.shadowOffsetX=0,a.shadowOffsetY=0},renderAnimation:function(e){var t,a;this.isStealth?e.globalAlpha=.5:e.globalAlpha=1,this.animation?.frames?.length&&(t=performance.now(),a=this.animation.frames[this.animation.currentFrame],t-this.animation.lastFrameTime>a.delay&&(this.animation.currentFrame=(this.animation.currentFrame+1)%this.animation.frames.length,this.animation.lastFrameTime=t),a.imageElement?.complete&&e.drawImage(a.imageElement,this.position.x+16-a.width/2,this.position.y+24-a.height/2,a.width,a.height),e.globalAlpha=1)},show:function(t){let e={width:0,height:0,fillStyle:"black",borderColor:"black"};e=this.targeted?{width:18,height:7,fillStyle:"rgba(255, 0, 0, 0.35)",borderColor:"rgba(255, 0, 0, 0.8)"}:{width:15,height:5,fillStyle:"rgba(0, 0, 0, 0.35)",borderColor:"transparent"},t.save(),t.beginPath(),t.ellipse(this.position.x+16,this.position.y+40,e.width,e.height,0,0,2*Math.PI),t.strokeStyle=e.borderColor,t.lineWidth=1,t.stroke(),t.beginPath(),t.ellipse(this.position.x+16,this.position.y+40,e.width,e.height,0,0,2*Math.PI),t.fillStyle=e.fillStyle,t.fill(),t.closePath(),t.restore(),t.globalAlpha=1,t.font="14px 'Comic Relief'",this.isStealth?t.fillStyle="rgba(97, 168, 255, 1)":t.fillStyle="white",t.textAlign="center";var a=players.find(e=>e.id===cachedPlayerId);if(a){let e;var n=s.id===a?.id,i=!this.isStealth;this.isAdmin&&i&&(this._adminColorHue=(this._adminColorHue+2)%360,e=`hsl(${this._adminColorHue}, 100%, 50%)`),e=n&&i&&!this.isAdmin?"#ffe561":this.isStealth?"rgba(97, 168, 255, 1)":e||(a.party?.includes(this.username)?"#00ff88ff":a.friends.includes(this.username)?"#00b7ffff":"#FFFFFF"),t.fillStyle=e,t.shadowColor="black",t.shadowBlur=2,t.shadowOffsetX=0,t.strokeStyle="black",this.isGuest?s.username="Guest":s.username=s.username.charAt(0).toUpperCase()+s.username.slice(1),t.strokeText(s.username,this.position.x+16,this.position.y+65),t.fillText(s.username,this.position.x+16,this.position.y+65),!this.isStealth&&(s.id!==cachedPlayerId&&!this.targeted||(t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(this.position.x-34,this.position.y+71,100,3),t.shadowBlur=2,n=this.stats.health/this.stats.max_health,t.fillStyle=n<.3?"#C81D1D":n<.5?"#C87C1D":n<.8?"#C8C520":"#519D41",t.fillRect(this.position.x-34,this.position.y+71,100*n,3)),s.id!==cachedPlayerId&&!this.targeted||(t.fillStyle="rgba(0, 0, 0, 0.8)",t.fillRect(this.position.x-34,this.position.y+76,100,3),t.fillStyle="#469CD9",t.fillRect(this.position.x-34,this.position.y+76,this.stats.stamina/this.stats.max_stamina*100,3)),s.id===cachedPlayerId||this.targeted)&&(t.textAlign="left",t.font="12px 'Comic Relief'",t.fillStyle="white",t.shadowColor="black",t.shadowBlur=2,t.fillText(""+this.stats.level,this.position.x-45,this.position.y+81)),t.shadowColor="transparent",t.shadowBlur=0,this.renderAnimation(t)}}};players.push(e),s.id===cachedPlayerId&&(cameraX=e.position.x-window.innerWidth/2+8,cameraY=e.position.y-window.innerHeight/2+48,window.scrollTo(cameraX,cameraY),updateFriendsList({friends:s.friends||[]}),createPartyUI(s.party||[]),updateXp(s.stats.xp,s.stats.level,s.stats.max_xp))}function getLines(t,e,a){var n=e.split(" "),i=[];let s=n[0];for(let e=1;e<n.length;e++){var o=n[e];t.measureText(s+" "+o).width<a?s+=" "+o:(i.push(s),s=o)}return i.push(s),i}function updateHealthBar(e,t){var a=Math.max(0,Math.min(1,t/100));e.animate([{transform:`scaleX(${a})`}],{duration:0,fill:"forwards"});let n="green";t<30?n="red":t<50?n="orange":t<80&&(n="yellow"),Array.from(e.classList).find(e=>["green","yellow","orange","red"].includes(e))!==n&&(e.classList.remove("green","yellow","orange","red"),e.classList.add(n)),e.classList.contains("ui")||e.classList.add("ui")}function updateStaminaBar(e,t){t=Math.max(0,Math.min(1,t/100));e.animate([{transform:`scaleX(${t})`}],{duration:0,fill:"forwards"})}window.addEventListener("keydown",async t=>{if("ContextMenu"!==t.key&&"ContextMenu"!==t.code||(contextMenuKeyTriggered=!0),blacklistedKeys.has(t.code))"Tab"!==t.code||contextMenuKeyTriggered||((e=players.find(e=>e.targeted))&&(e.targeted=!1),sendRequest({type:"TARGETCLOSEST",data:null})),t.preventDefault();else if(loaded&&("block"!==pauseMenu.style.display||"Escape"===t.code)&&(chatInput!==document.activeElement&&document.activeElement!=friendsListSearch||["Enter","Escape"].includes(t.code))){movementKeys.has(t.code)&&(pressedKeys.add(t.code),isKeyPressed||(isKeyPressed=!0,isMoving)||handleKeyPress());var e=Date.now(),a=keyHandlers[t.code];if(a&&!(cooldowns[t.code]&&e-cooldowns[t.code]<COOLDOWN_DURATION)){cooldowns[t.code]=e;try{await a()}catch(e){console.error(`Error handling key ${t.code}:`,e)}}}}),window.addEventListener("keyup",e=>{chatInput!==document.activeElement&&movementKeys.has(e.code)&&(pressedKeys.delete(e.code),0===pressedKeys.size)&&(isKeyPressed=!1)}),window.addEventListener("resize",()=>{updateViewportCache();var e=players.find(e=>e.id===cachedPlayerId);e&&(cameraX=e.position.x-window.innerWidth/2+8,cameraY=e.position.y-window.innerHeight/2+48,window.scrollTo(cameraX,cameraY)),document.getElementById("context-menu")&&document.getElementById("context-menu").remove()}),window.addEventListener("blur",()=>{isKeyPressed=!1,pressedKeys.clear()}),document.getElementById("pause-menu-action-back")?.addEventListener("click",()=>{pauseMenu.style.display="none"}),document.getElementById("pause-menu-action-options")?.addEventListener("click",()=>{pauseMenu.style.display="none",optionsMenu.style.display="block"}),document.getElementById("pause-menu-action-exit")?.addEventListener("click",()=>{sendRequest({type:"LOGOUT",data:null}),window.location.href="/"}),fpsSlider.addEventListener("input",()=>{document.getElementById("limit-fps-label").innerText=`FPS: (${fpsSlider.value})`}),musicSlider.addEventListener("input",()=>{document.getElementById("music-volume-label").innerText=`Music: (${musicSlider.value})`}),effectsSlider.addEventListener("input",()=>{document.getElementById("effects-volume-label").innerText=`Effects: (${effectsSlider.value})`}),[fpsSlider,musicSlider,effectsSlider,mutedCheckbox].forEach(e=>{e.addEventListener("change",()=>{sendRequest({type:"CLIENTCONFIG",data:{fps:parseInt(fpsSlider.value),music_volume:parseInt(musicSlider.value)||0,effects_volume:parseInt(effectsSlider.value)||0,muted:mutedCheckbox.checked}})})});let partyContextActions={"kick-player":{label:"Kick",allowed_self:!1,only_self:!1,handler:e=>{sendRequest({type:"KICK_PARTY_MEMBER",data:{username:e}})}},"leave-party":{label:"Leave Party",allowed_self:!0,only_self:!0,handler:e=>{sendRequest({type:"LEAVE_PARTY",data:{username:e}})}}},contextActions={"inspect-player":{label:"Inspect",allowed_self:!0,handler:e=>{console.log("Inspecting player "+e)}},"send-message":{label:"Send Message",allowed_self:!1,handler:t=>{var e=document.getElementById("chat-input"),a=players.find(e=>e.id===t)?.username||null;a&&(e.value=`/w ${a} `,e.focus())}},"invite-to-party":{label:"Invite to Party",allowed_self:!1,handler:e=>{sendRequest({type:"INVITE_PARTY",data:{id:e}})}},"add-friend":{label:"Add Friend",allowed_self:!1,handler:e=>{sendRequest({type:"ADD_FRIEND",data:{id:e}})}},"remove-friend":{label:"Remove Friend",allowed_self:!1,handler:e=>{sendRequest({type:"REMOVE_FRIEND",data:{id:e}})}},"invite-to-guild":{label:"Invite to Guild",allowed_self:!1,handler:e=>{console.log(`Inviting ${e} to guild`)}},"block-player":{label:"Block Player",allowed_self:!1,handler:e=>{console.log("Blocking player "+e)}},"report-player":{label:"Report Player",allowed_self:!1,handler:e=>{console.log("Reporting player "+e)}}};function createPartyContextMenu(e,l){if(loaded){document.getElementById("context-menu")?.remove();let s=document.createElement("div"),o=(s.id="context-menu",s.style.left=e.clientX+"px",s.style.top=e.clientY+"px",e.clientX+200>window.innerWidth&&(s.style.left=e.clientX-200+"px"),e.clientX-200<0&&(s.style.left=e.clientX+50+"px"),window.innerHeight<e.clientY+150&&(s.style.top=e.clientY-150+"px"),e.clientY-150<0&&(s.style.top=e.clientY+50+"px"),s.dataset.username=l.toLowerCase(),document.createElement("ul"));let r=players.find(e=>e.id===cachedPlayerId)?.username.toLowerCase()===l.toLowerCase();Object.entries(partyContextActions).forEach(([e,{label:t,handler:a,only_self:n,allowed_self:i}])=>{n&&!r||!i&&r||((n=document.createElement("li")).id="context-"+e,n.innerText=t,n.onclick=e=>{e.stopPropagation(),a(l),s.remove()},o.appendChild(n))}),s.appendChild(o),overlay.appendChild(s),document.addEventListener("click",()=>s.remove(),{once:!0})}}function createContextMenu(e,d){if(loaded){document.getElementById("context-menu")?.remove();let i=document.createElement("div"),s=(i.id="context-menu",i.style.left=e.clientX+"px",i.style.top=e.clientY+"px",e.clientX+200>window.innerWidth&&(i.style.left=e.clientX-200+"px"),e.clientX-200<0&&(i.style.left=e.clientX+50+"px"),window.innerHeight<e.clientY+150&&(i.style.top=e.clientY-150+"px"),e.clientY-150<0&&(i.style.top=e.clientY+50+"px"),i.dataset.id=d,document.createElement("ul")),o=d===cachedPlayerId;var e=players.find(e=>e.id===cachedPlayerId),t=players.find(e=>e.id===d);let r=e?.friends?.includes(t?.username?.toString())||!1,l=e?.party?.includes(t?.username?.toString())||!1;Object.entries(contextActions).forEach(([e,{label:t,handler:a,allowed_self:n}])=>{!n&&o||"invite-to-party"===e&&l||"add-friend"===e&&r||"remove-friend"===e&&!r||((n=document.createElement("li")).id="context-"+e,n.innerText=t,n.onclick=e=>{e.stopPropagation(),a(d),i.remove()},s.appendChild(n))}),i.appendChild(s),overlay.appendChild(i),document.addEventListener("click",()=>i.remove(),{once:!0})}}async function encryptRsa(e,t){e=cleanBase64Key(e),e=await window.crypto.subtle.importKey("spki",new Uint8Array(atob(e).split("").map(e=>e.charCodeAt(0))),{name:"RSA-OAEP",hash:"SHA-256"},!1,["encrypt"]),t=(new TextEncoder).encode(t),e=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},e,t);return new Uint8Array(e)}function cleanBase64Key(e){return e.replace(/-----BEGIN PUBLIC KEY-----|-----END PUBLIC KEY-----|\s+/g,"")}document.addEventListener("contextmenu",e=>{if(loaded)if(contextMenuKeyTriggered)e.preventDefault(),contextMenuKeyTriggered=!1;else{if(e.target?.classList.contains("ui"))return(t=e.target.closest(".party-member"))?((t=t.dataset.username)&&createPartyContextMenu(e,t),void e.preventDefault()):void 0;var t=canvas.getBoundingClientRect();let a=e.clientX-t.left,n=e.clientY-t.top;t=players.find(e=>{var t=e.position.x+16,e=e.position.y+24;return a>=t-16&&a<=t+16&&n>=e-24&&n<=e+24});t?createContextMenu(e,t.id):((e=document.getElementById("context-menu"))&&e.remove(),sendRequest({type:"TELEPORTXY",data:{x:Math.floor(a-canvas.width/2-16),y:Math.floor(n-canvas.height/2-24)}}))}}),document.addEventListener("click",e=>{var t,a;loaded&&!e.target?.classList.contains("ui")&&((t=document.getElementById("context-menu"))&&!t.contains(e.target)&&t.remove(),t=canvas.getBoundingClientRect(),a=e.clientX-t.left,e=e.clientY-t.top,t=a-canvas.width/2-16,a=e-canvas.height/2-24,(e=players.find(e=>e.targeted))&&(e.targeted=!1),sendRequest({type:"SELECTPLAYER",data:{x:t,y:a}}))});let notificationContainer=document.getElementById("game-notification-container"),notificationMessage=document.getElementById("game-notification-message"),clearNotificationTimeout=null;function showNotification(e,t=!0,a=!1){notificationContainer&&notificationMessage&&(notificationMessage.innerText=e,notificationContainer.style.display="flex",e=5e3+100*e.length,t?(clearNotificationTimeout&&clearTimeout(clearNotificationTimeout),clearNotificationTimeout=setTimeout(()=>{notificationContainer.style.display="none",a&&("@Electron/Frostfire-Forge-Client"===window.navigator.userAgent?window.close():window.location.href="/")},e)):a&&setTimeout(()=>{"@Electron/Frostfire-Forge-Client"===window.navigator.userAgent?window.close():window.location.href="/"},e))}function sendRequest(e){sentRequests++,socket.send(packet.encode(JSON.stringify(e)))}function stopMovement(){sendRequest({type:"MOVEXY",data:"ABORT"}),pressedKeys.clear(),isKeyPressed=!1,isMoving=!1}function createInvitationPopup(e){var t=document.getElementById("invitation-popup");t&&t.remove();let a=document.createElement("div");a.id="invitation-popup",a.className="popup",a.innerHTML=`
    <h2>Invitation</h2>
    <p>${e.message}</p>
    <button id="accept-invitation">Accept</button>
    <button id="decline-invitation">Decline</button>
  `,document.body.appendChild(a);var t=document.getElementById("accept-invitation"),n=document.getElementById("decline-invitation");let i;switch(e.action.toUpperCase()){case"FRIEND_REQUEST":i={type:"INVITATION_RESPONSE",data:{authorization:e.authorization,originator:e.originator,action:"FRIEND_REQUEST"}};break;case"INVITE_PARTY":i={type:"INVITATION_RESPONSE",data:{authorization:e.authorization,originator:e.originator,action:"INVITE_PARTY"}}}i&&(t?.addEventListener("click",()=>{i.data.response="ACCEPT",sendRequest(i),a.remove()}),n?.addEventListener("click",()=>{i.data.response="DECLINE",sendRequest(i),a.remove()}))}function updateFriendOnlineStatus(t,a){setTimeout(()=>{var e=Array.from(friendsList.querySelectorAll(".friend-name"));e.length&&e.forEach(e=>{e.innerText.toLowerCase()===t.toLowerCase()&&(e=e.nextElementSibling)&&(e.classList.toggle("online",a),e.classList.toggle("offline",!a),e.innerText=a?"Online":"Offline")})},2e3)}function updateFriendsList(a){if(players.find(e=>e.id===cachedPlayerId)&&a?.friends){let i=Array.from(friendsList.querySelectorAll(".friend-name"));i.forEach(e=>{var t=e.innerText.toLowerCase();a.friends.map(e=>e.toLowerCase()).includes(t)||e.parentElement?.remove()}),a.friends.forEach(t=>{var e,a,n;i.some(e=>e.innerText.toLowerCase()===t.toLowerCase())||((e=document.createElement("div")).classList.add("friend-item","ui"),(a=document.createElement("div")).classList.add("friend-name"),a.classList.add("ui"),a.innerText=t.charAt(0).toUpperCase()+t.slice(1),e.appendChild(a),a=document.createElement("div"),n=players.some(e=>e.username.toLowerCase()===t.toLowerCase()&&e.id!==cachedPlayerId),a.classList.add("friend-status",n?"online":"offline"),a.classList.add("ui"),a.innerText=n?"Online":"Offline",e.appendChild(a),(n=document.createElement("button")).innerText="X",n.classList.add("remove-friend-button"),n.classList.add("ui"),n.onclick=()=>{sendRequest({type:"REMOVE_FRIEND",data:{username:t}})},e.appendChild(n),friendsList.appendChild(e))})}}function createPartyUI(e){let t=document.getElementById("party-container");if(t)if(0===e.length)t.querySelectorAll(".party-member").forEach(e=>t.removeChild(e));else{var n=Array.from(t.querySelectorAll(".party-member-username"));let a=new Map;n.forEach(e=>{var t=e.textContent?.toLowerCase();t&&(e=e.closest(".party-member"))&&a.set(t,e)});var i,s,o,r=new Set(e.map(e=>e.toLowerCase()));for([i,s]of a.entries())r.has(i)||t.removeChild(s);e.sort((e,t)=>e.toLowerCase().localeCompare(t.toLowerCase()));for(o of e){var l,d=o.toLowerCase();a.has(d)||((l=document.createElement("div")).className="party-member ui",l.dataset.username=d,(d=document.createElement("div")).className="party-member-username ui",d.innerText=o.charAt(0).toUpperCase()+o.slice(1),l.appendChild(d),t.appendChild(l))}}}chatInput.addEventListener("focus",()=>{stopMovement()}),friendsListSearch.addEventListener("focus",()=>{stopMovement()}),chatInput.addEventListener("blur",()=>{sendRequest({type:"MOVEXY",data:"ABORT"}),pressedKeys.clear(),isKeyPressed=!1,isMoving=!1}),setInterval(()=>{packetsSentReceived.innerText!==`Sent: ${sentRequests}, Received: `+receivedResponses&&(packetsSentReceived.innerText=`Sent: ${sentRequests}, Received: `+receivedResponses,sentRequests=0,receivedResponses=0)},1e3),friendsListSearch.addEventListener("input",()=>{let t=friendsListSearch.value.toLowerCase();var e=Array.from(friendsList.querySelectorAll(".friend-item"));t?e.forEach(e=>{(e.querySelector(".friend-name")?.textContent?.toLowerCase()||"").includes(t)?e.style.display="block":e.style.display="none"}):e.forEach(e=>{e.style.display="block"})});