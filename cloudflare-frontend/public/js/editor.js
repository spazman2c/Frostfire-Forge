import{APNGEncoder}from"../libs/apng_encoder";document.addEventListener("DOMContentLoaded",()=>{let t=document.getElementById("editor-dropzone"),c=document.getElementById("editor-images-container"),a=(["dragenter","dragover","dragleave","drop"].forEach(e=>{t?.addEventListener(e,n),document.body.addEventListener(e,n)}),["dragenter","dragover"].forEach(e=>{t?.addEventListener(e,()=>{t?.classList.add("highlight")})}),["dragleave","drop"].forEach(e=>{t?.addEventListener(e,()=>{t?.classList.remove("highlight")})}),t?.addEventListener("drop",e=>{e=e.dataTransfer;e&&Array.from(e.files).forEach(e=>{var t;"image/png"===e.type&&(e=e,(t=new FileReader).onload=e=>{let a=document.createElement("div");a.className="image-wrapper",a.draggable=!0,a.addEventListener("dragstart",e=>{var t=document.elementFromPoint(e.clientX,e.clientY);t instanceof HTMLInputElement||t instanceof HTMLButtonElement||t?.closest(".frame-duration")||t?.closest(".image-controls")?e.preventDefault():(a.classList.add("dragging"),e.dataTransfer?.setData("text/plain",""))}),a.addEventListener("dragend",()=>{a.classList.remove("dragging")}),a.addEventListener("dragover",t=>{t.preventDefault();var e=document.querySelector(".dragging");if(e&&c){var n=Array.from(c.querySelectorAll(".image-wrapper:not(.dragging)")),a=n.find(e=>{e=e.getBoundingClientRect();return t.clientY<e.top+e.height/2});if(!a&&0<n.length){n=n[n.length-1].getBoundingClientRect();if(t.clientY>n.bottom)return void c.appendChild(e)}c.insertBefore(e,a||null)}});var t=document.createElement("div"),n=(t.className="image-content",document.createElement("img")),e=(n.src=e.target?.result,document.createElement("div")),r=(e.className="frame-duration",document.createElement("input")),o=(r.type="number",r.value="120",r.min="1",document.createElement("span")),r=(o.textContent="ms",e.appendChild(r),e.appendChild(o),document.createElement("div"));r.className="image-controls";let l=document.createElement("button");l.className="duplicate-button",l.title="Duplicate",l.onclick=()=>{let n=a.cloneNode(!0);var e=a.querySelector(".frame-duration input"),t=n.querySelector(".frame-duration input"),t=(e&&t&&(t.value=e.value),n.draggable=!0,n.addEventListener("dragstart",e=>{var t=document.elementFromPoint(e.clientX,e.clientY);t instanceof HTMLInputElement||t instanceof HTMLButtonElement||t?.closest(".frame-duration")||t?.closest(".image-controls")?e.preventDefault():(n.classList.add("dragging"),e.dataTransfer?.setData("text/plain",""))}),n.addEventListener("dragend",()=>{n.classList.remove("dragging")}),n.addEventListener("dragover",t=>{t.preventDefault();var e=document.querySelector(".dragging");if(e&&c){var n=Array.from(c.querySelectorAll(".image-wrapper:not(.dragging)")),a=n.find(e=>{e=e.getBoundingClientRect();return t.clientY<e.top+e.height/2});if(!a&&0<n.length){n=n[n.length-1].getBoundingClientRect();if(t.clientY>n.bottom)return void c.appendChild(e)}c.insertBefore(e,a||null)}}),n.querySelector(".duplicate-button")),e=(t&&(t.onclick=l.onclick),n.querySelector(".delete-button"));e&&(e.onclick=()=>n.remove()),c?.appendChild(n)};o=document.createElement("button");o.className="delete-button",o.title="Delete",o.onclick=()=>a.remove(),r.appendChild(l),r.appendChild(o),t.appendChild(n),t.appendChild(e),t.appendChild(r),a.appendChild(t),c?.appendChild(a)},t.readAsDataURL(e),setTimeout(g,0))})}),"animation_editor_autosave"),r=document.getElementById("autosave-checkbox");function n(e){e.preventDefault(),e.stopPropagation()}r.checked="true"===localStorage.getItem("autosave_enabled"),r.checked&&(e=localStorage.getItem(a))&&u(e),r.addEventListener("change",()=>{localStorage.setItem("autosave_enabled",r.checked.toString()),r.checked?g():localStorage.removeItem(a)});var e=document.getElementById("animate-button");let o=null,l=null;function i(){console.log("Starting animation generation");let r=Array.from(document.querySelectorAll(".image-wrapper")).map(e=>{var t=e.querySelector("img"),e=e.querySelector(".frame-duration input");return console.log("Frame found:",{src:t?.src,duration:e?.value}),{src:t?.src||"",duration:parseInt(e?.value||"120",10)}});if(0===r.length)console.log("No frames found");else{console.log("Total frames:",r.length);let t=document.createElement("canvas");t.getContext("2d")?Promise.all(r.map(a=>new Promise((e,t)=>{let n=new Image;n.onload=()=>{console.log("Image loaded:",a.src),e(n)},n.onerror=e=>{console.error("Image load error:",a.src,e),t(new Error("Failed to load image"))},n.src=a.src}))).then(e=>{console.log("All images loaded, starting encoding"),t.width=e[0].width,t.height=e[0].height;let a=new APNGEncoder;return Promise.all(e.map((e,t)=>{console.log("Processing frame",t);var n=document.createElement("canvas");return n.width=e.width,n.height=e.height,n.getContext("2d").drawImage(e,0,0),a.addFrame(n,{delay:r[t].duration})})).then(()=>(console.log("Frames added, finishing encoding"),a.finish()))}).then(e=>{console.log("Animation generated, creating blob");var e=new Blob([e],{type:"image/png"}),t=document.getElementById("preview-section"),n=(t&&t.remove(),(o=document.createElement("div")).id="preview-section",o.style.position="fixed",o.style.top="90px",o.style.right="-3px",o.style.zIndex="1000",o.style.backgroundColor="transparent",o.style.padding="10px",o.style.borderRadius="4px",(t=document.createElement("button")).innerHTML="Ã—",t.style.position="absolute",t.style.right="5px",t.style.top="5px",t.style.background="none",t.style.border="none",t.style.color="#fff",t.style.fontSize="20px",t.style.cursor="pointer",t.style.padding="0 5px",t.onclick=()=>o?.remove(),document.createElement("div"));n.id="preview-container",n.style.width="fit-content",n.style.height="fit-content",(l=document.createElement("img")).id="preview-image",l.style.maxWidth="300px",l.style.height="auto",l.src='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24"%3E%3Cpath fill="%23666" d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/%3E%3C/svg%3E',n.appendChild(l),o.appendChild(t),o.appendChild(n),(t=document.getElementById("editor-navbar"))&&t.parentNode&&t.parentNode.insertBefore(o,t.nextSibling),l&&o&&(l.src=URL.createObjectURL(e),l.onerror=e=>console.error("Preview image load error:",e),o.classList.add("visible"),console.log("Preview displayed"))}).catch(e=>{console.error("Animation generation failed:",e)}):console.error("Failed to get canvas context")}}e?(console.log("Animate button found, attaching listener"),e.addEventListener("click",()=>{console.log("Animate button clicked"),i()})):console.error("Animate button not found");e=document.createElement("button");e.id="save-button",e.textContent="Save",e.onclick=function(){var e=Array.from(document.querySelectorAll(".image-wrapper")).map(e=>{var t=e.querySelector("img"),e=e.querySelector(".frame-duration input");return{imageData:t?.src||"",duration:parseInt(e?.value||"120",10)}}),e={version:1,frames:e},e=new Blob([JSON.stringify(e)],{type:"application/json"}),e=URL.createObjectURL(e),t=document.createElement("a");t.href=e,t.download="animation.forge",t.click(),URL.revokeObjectURL(e),g()},document.getElementById("editor-navbar")?.appendChild(e);let d=document.createElement("input");d.type="file",d.accept=".forge",d.style.display="none",d.onchange=function(e){var e=e.target,t=e.files?.[0];var n;t&&((n=new FileReader).onload=async e=>{try{var t=e.target?.result;u(t),r.checked&&localStorage.setItem(a,t)}catch(e){console.error("Error loading configuration:",e),alert("Error loading configuration file")}},n.readAsText(t),e.value="")};e=document.createElement("button");function s(n){n.addEventListener("dragstart",e=>{var t=document.elementFromPoint(e.clientX,e.clientY);t instanceof HTMLInputElement||t instanceof HTMLButtonElement||t?.closest(".frame-duration")||t?.closest(".image-controls")?e.preventDefault():(n.classList.add("dragging"),e.dataTransfer?.setData("text/plain",""))}),n.addEventListener("dragend",()=>{n.classList.remove("dragging")})}e.id="load-button",e.textContent="Load",e.onclick=()=>d.click(),document.getElementById("editor-navbar")?.appendChild(e),document.body.appendChild(d);e=document.getElementById("editor-content");let m=null;function u(e){var t,e=JSON.parse(e),n=(c&&(c.innerHTML=""),document.getElementById("preview-section"));n&&n.remove();for(t of e.frames){let e=document.createElement("div");e.className="image-wrapper",e.draggable=!0,s(e);var a=document.createElement("div"),r=(a.className="image-content",document.createElement("img")),o=(r.src=t.imageData,document.createElement("div")),l=(o.className="frame-duration",document.createElement("input")),i=(l.type="number",l.value=t.duration.toString(),l.min="1",document.createElement("span")),l=(i.textContent="ms",o.appendChild(l),o.appendChild(i),document.createElement("div")),i=(l.className="image-controls",document.createElement("button")),d=(i.className="duplicate-button",i.title="Duplicate",i.onclick=function a(r){return()=>{let e=r.cloneNode(!0);var t=r.querySelector(".frame-duration input"),n=e.querySelector(".frame-duration input");t&&n&&(n.value=t.value),e.draggable=!0,s(e),(n=e.querySelector(".duplicate-button"))&&(n.onclick=a(e)),(t=e.querySelector(".delete-button"))&&(t.onclick=()=>e.remove()),c?.appendChild(e),setTimeout(g,0)}}(e),document.createElement("button"));d.className="delete-button",d.title="Delete",d.onclick=()=>e.remove(),l.appendChild(i),l.appendChild(d),a.appendChild(r),a.appendChild(o),a.appendChild(l),e.appendChild(a),c?.appendChild(e)}}function g(){var e;r.checked&&(e={version:1,frames:Array.from(document.querySelectorAll(".image-wrapper")).map(e=>{var t=e.querySelector("img"),e=e.querySelector(".frame-duration input");return{imageData:t?.src||"",duration:parseInt(e?.value||"120",10)}})},localStorage.setItem(a,JSON.stringify(e)))}c?.addEventListener("dragover",n=>{n.preventDefault();var a=document.querySelector(".dragging");if(a&&c){let e=document.getElementById("editor-dropzone");if(e){var r=e.getBoundingClientRect();let t=n.clientY;m&&(clearInterval(m),m=null),t-r.top<300?m=window.setInterval(()=>{e.scrollBy(0,-3)},16):r.bottom-t<300&&(m=window.setInterval(()=>{e.scrollBy(0,3)},16));n=Array.from(c.querySelectorAll(".image-wrapper:not(.dragging)")),r=n.find(e=>{e=e.getBoundingClientRect();return t<e.top+e.height/2});if(!r&&0<n.length){n=n[n.length-1].getBoundingClientRect();if(t>n.bottom)return void c.appendChild(a)}c.insertBefore(a,r||null)}}}),e?.addEventListener("dragend",()=>{m&&(clearInterval(m),m=null)}),c?.addEventListener("dragend",()=>g()),c?.addEventListener("click",e=>{e.target.matches(".delete-button, .duplicate-button")&&setTimeout(g,0)}),c?.addEventListener("change",e=>{e.target.matches(".frame-duration input")&&g()})});